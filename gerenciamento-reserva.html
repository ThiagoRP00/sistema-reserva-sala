<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
    integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <title>Gerenciamento de Reservas</title>
</head>

<body>
  <dialog id="password-box">
    <p>Senha de acesso</p>
    <div class="input-field">
      <input type="password" id="access-password" placeholder="Senha">
    </div>
  </dialog>
  <section id="gerenciamento-reserva">
    <img src="https://midiasstoragesec.blob.core.windows.net/001/2025/11/seintec_01.png" alt="">
    <h2>SEINTEC | Gerenciamento de Reservas</h2>
    <form id="sheetdb-form">
      <div class="form-row">
        <div class="input-field">
          <input type="text" name="nome" id="nome" placeholder="Nome">
        </div>
        <select name="data[setor]" id="setor" class="input-field">
          <option value="" disabled selected>Setor</option>
          <option value="ESE">ESE</option>
          <option value="ECC">ECC</option>
          <option value="ASURE">ASURE</option>
          <option value="SEOM">SEOM</option>
          <option value="SEAFIN">SEAFIN</option>
          <option value="SEPES">SEPES</option>
          <option value="SEGRE">SEGRE</option>
          <option value="SEINTEC">SEINTEC</option>
          <option value="SEFISC">SEFISC</option>
          <option value="SEFIM">SEFIM</option>
          <option value="SECOMSE">SECOMSE</option>
          <option value="SEFREP">SEFREP</option>
          <option value="SEAPE">SEAPE</option>
          <option value="SEMAT">SEMAT</option>
          <option value="SEVESC">SEVESC</option>
          <option value="SETEC">SETEC</option>
        </select>
        <select name="data[sala]" id="sala" class="input-field">
          <option value="" disabled selected>Sala</option>
          <option value="Sala de Transmissão">Sala de Transmissão</option>
          <option value="Midioteca">Midioteca</option>
          <option value="Auditório">Auditório</option>
          <option value="Sala de Reunião">Sala de Reunião</option>
          <option value="Norte 1">Norte I</option>
          <option value="Alfabetiza">Alfabetiza</option>
        </select>
      </div>
      <div class="form-row">
        <div class="input-field">
          <input type="date" name="data[data]" id="data">
        </div>
        <div class="input-field">
          <input type="time" name="data[hora]" id="hora">
        </div>
      </div>
      <button type="submit" class="default-btn">Buscar</button>
      <button onclick="excluirReservas()" class="default-btn"><i class="fa-solid fa-trash-can"></i> Excluir</button>
    </form>

    <div id="tabela-container">
      <table>
        <thead>
          <tr>
            <th>
              <input type="checkbox" id="selecionar-todos">
            </th>
            <th>Nome</th>
            <th>Sobrenome</th>
            <th>Setor</th>
            <th>E-mail</th>
            <th>Telefone</th>
            <th>Sala</th>
            <th>Data</th>
            <th>Hora</th>
            <th>Equipamentos</th>
            <th>Observações</th>
          </tr>
        </thead>
        <tbody id="reservas">

        </tbody>
      </table>
    </div>
  </section>
  <script>
    const passwordBox = document.getElementById('password-box');
    // passwordBox.showModal();

    function carregarReservas(dados) {
      const reservasTbody = document.getElementById('reservas');
      reservasTbody.innerHTML = '';
      dados.forEach(reserva => {
        const linhas = document.createElement('tr');

        function adicionaZero(numero) {
          if (numero <= 9) {
            return "0" + numero;
          } else {
            return numero;
          }
        }
        const diaSemana = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
        const meses = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        let data = new Date(reserva.data + "T00:00:00");
        let dataFormatada = (diaSemana[data.getDay()] + ", " + (adicionaZero(data.getDate()) + " " + meses[(data.getMonth())] + " " + data.getFullYear()));

        let horarios = JSON.parse(reserva.horarios).join(', ');

        let equipamentos;
        try {
          equipamentos = JSON.parse(reserva.equipamentos).join(', ');
        } catch {
          equipamentos = '';
        }
        linhas.innerHTML = `
          <td><input type="checkbox" name="reserva" value="${reserva.id}"></td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.nome}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.sobrenome}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.setor}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.email}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.telefone}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.sala}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${dataFormatada}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${horarios}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${equipamentos}</td>
          <td><button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${reserva.observacoes}</td>
        `;
        reservasTbody.appendChild(linhas);
      });
    }
    fetch('https://sheetdb.io/api/v1/g7hajfb9evf5v?sort_by=data&sort_order=desc')
      .then(response => response.json())
      .then(carregarReservas);

    const form = document.getElementById('sheetdb-form');
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      const nome = document.getElementById('nome').value;
      const setor = document.getElementById('setor').value;
      const sala = document.getElementById('sala').value;
      const data = document.getElementById('data').value;
      const hora = document.getElementById('hora').value;

      form.reset();

      let pesquisa = [];
      if (nome) {
        pesquisa.push(`nome=${nome}`);
      }
      if (setor) {
        pesquisa.push(`setor=${setor}`);
      }
      if (sala) {
        pesquisa.push(`sala=${sala}`);
      }
      if (data) {
        pesquisa.push(`data=${data}`);
      }

      let api = `https://sheetdb.io/api/v1/g7hajfb9evf5v`;
      if (pesquisa.length) {
        api += '/search?' + pesquisa.join('&');
      }

      fetch(api)
        .then(response => response.json())
        .then(function (dados) {
          let resultado = dados;
          if (hora) {
            resultado = dados.filter(reserva => {
              try {
                return JSON.parse(reserva.horarios)
                  .map(h => h.trim())
                  .includes(hora.trim());
              } catch {
                0
                return false;
              }
            });
          }
          carregarReservas(resultado);
        });
    });

    document.getElementById('selecionar-todos').addEventListener('change', function () {
      const checkboxes = document.querySelectorAll('input[name="reserva"]');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });

    function excluirReservas() {
      const checkboxes = document.querySelectorAll('input[name="reserva"]:checked');
      if (checkboxes.length === 0) {
        alert('Selecione ao menos uma reserva para excluir.');
        return;
      }
      if (!confirm(`Tem certeza que deseja excluir ${checkboxes.length} reserva(s)?`)) {
        return;
      }
      const ids = Array.from(checkboxes).map(cb => cb.value);
      let deletions = ids.map(id => {
        return fetch(`https://sheetdb.io/api/v1/g7hajfb9evf5v/id/${id}`, {
          method: 'DELETE',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        }).then(response => response.json());
      });
      Promise.all(deletions).then(() => {
        alert('Reservas excluídas com sucesso!');
        location.reload();
      }).catch(() => {
        alert('Ocorreu um erro ao excluir as reservas.');
      });
    }

    // Eventos de hover para mostrar/ocultar botão de edição
    document.addEventListener('mouseover', function (e) {
      const td = e.target.closest('td:not(:first-child)');
      if (td && !td.querySelector('input[type="text"], input[type="date"]')) {
        const editBtn = td.querySelector('.edit-btn');
        if (editBtn) {
          editBtn.classList.add('active');
        }
      }
    });

    document.addEventListener('mouseout', function (e) {
      const td = e.target.closest('td:not(:first-child)');
      if (td) {
        const editBtn = td.querySelector('.edit-btn');
        if (editBtn) {
          editBtn.classList.remove('active');
        }
      }
    });

    // Evento de clique para editar
    document.addEventListener('click', function (e) {
      const editBtn = e.target.closest('.edit-btn');
      if (!editBtn) return;

      e.preventDefault();
      e.stopPropagation();

      const td = editBtn.closest('td');
      const tr = editBtn.closest('tr');
      const checkbox = tr.querySelector('input[type="checkbox"]');
      const reservaId = checkbox.value;

      // Mapear colunas para nomes de campo
      const campos = ['nome', 'sobrenome', 'setor', 'email', 'telefone', 'sala', 'data', 'horarios', 'equipamentos', 'observacoes'];
      const colIndex = Array.from(tr.querySelectorAll('td')).indexOf(td);
      const campo = campos[colIndex - 1];

      const conteudoAtual = td.textContent.replace(editBtn.textContent, '').trim();

      // Criar campo de edição
      const input = document.createElement('input');
      input.type = campo === 'data' ? 'date' : 'text';
      input.value = conteudoAtual;
      input.style.padding = '4px';
      input.style.width = '100%';
      input.style.boxSizing = 'border-box';

      // Substituir conteúdo
      td.innerHTML = '';
      td.appendChild(input);
      input.focus();
      input.select();

      // Função para restaurar
      const restaurar = () => {
        td.innerHTML = `<button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${conteudoAtual}`;
      };

      // Salvar ao pressionar Enter
      input.addEventListener('keydown', function (evt) {
        if (evt.key === 'Enter') {
          salvarEdicao(reservaId, campo, input.value, td, conteudoAtual);
        }
        if (evt.key === 'Escape') {
          restaurar();
        }
      });

      input.addEventListener('blur', function () {
        setTimeout(() => {
          if (input.parentElement === td) {
            restaurar();
          }
        }, 100);
      });
    });

    // Função para salvar a edição
    function salvarEdicao(reservaId, campo, novoValor, td, valorAnterior) {
      if (novoValor.trim() === '') {
        alert('O campo não pode estar vazio!');
        td.innerHTML = `<button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${valorAnterior}`;
        return;
      }

      if (novoValor === valorAnterior) {
        td.innerHTML = `<button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${valorAnterior}`;
        return;
      }

      let valorParaSalvar = novoValor;

      // Se for horarios ou equipamentos, transformar em JSON array
      if (campo === "horarios" || campo === "equipamentos") {
        const array = novoValor
          .split(/[,]\s*/)
          .map(x => x.trim())
          .filter(x => x.length > 0);

        valorParaSalvar = JSON.stringify(array);
      }

      // Montar o objeto final
      const dados = { [campo]: valorParaSalvar };


      // Enviar UPDATE para o banco de dados
      fetch(`https://sheetdb.io/api/v1/g7hajfb9evf5v/id/${reservaId}`, {
        method: 'PATCH',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ data: dados })
      })
        .then(response => response.json())
        .then(result => {
          alert('Registro atualizado com sucesso!');
          td.innerHTML = `<button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${novoValor}`;
        })
        .catch(error => {
          alert('Erro ao atualizar o registro!');
          console.error(error);
          td.innerHTML = `<button class="edit-btn"><i class="fa-solid fa-pen-to-square"></i></button> ${valorAnterior}`;
        });
    }

    // Enviar altura para o iframe
    function sendHeight() {
      parent.postMessage(
        { height: document.documentElement.scrollHeight },
        "*"
      );
    }

    window.addEventListener('load', sendHeight);

    window.addEventListener('resize', sendHeight);

    const observer = new MutationObserver(sendHeight);
    observer.observe(document.body, { childList: true, subtree: true, attributes: true });
  </script>

  <!-- Caixa de diálogo para senha de acesso e iframe para adicionar no site. 
  Altere a senha no código se necessário e adicione o link da página no src do iframe.

  <div id="password-box" style="display: flex; flex-direction: column; align-items: center; border: 2px solid black; padding: 20px; width: 300px; margin: 0 auto;">
    <p>Digite a senha:</p>
    <div style="margin-bottom: 10px;">
      <input type="password" id="passwordInput" />
    </div>
    <button id="submit-btn">Enviar</button>
  </div>

  <iframe id="reservaIframe" style="border: none;" src="LINK_PARA_O_ARQUIVO_HTML" width="100%" scrolling="no"></iframe>
  <script>
    const passwordBox = document.getElementById("password-box");
    const passwordInput = document.getElementById("passwordInput");
    const iframe = document.getElementById("iframe");

    iframe.style.display = "none";

    document.getElementById("submit-btn").addEventListener("click", function () {
      if (passwordInput.value === "Senha123") {
        passwordBox.style.display = "none";
        iframe.style.display = "block";
      } else {
        alert("Senha incorreta. Tente novamente.");
      }
    });

    window.addEventListener("message", function (event) {
      if (!event.data) return;
      if (event.data.height) {
        iframe.style.height = event.data.height + "px";
      }
      if (event.data.width) {
        console.log("iframe innerWidth:", event.data.width);
      }
    });
  </script> -->

</body>


</html>
